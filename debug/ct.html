<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="console"></div>
</body>
<script>
  let output = document.getElementById("console");

  function log(...args){
    output.appendChild(document.createElement("br"));
    output.appendChild(document.createElement("br"));
    for(let arg of args){
      if(typeof arg === "object"){
        arg = JSON.stringify(arg);
      }
      output.append(arg);
    }
  }

  async function getCameras(facingMode) {
    let verifyConstraints = function(capabilities){
      let result = true;
      if(facingMode){
        if(capabilities.facingMode && Array.isArray(capabilities.facingMode) && capabilities.facingMode.length>0 && capabilities.facingMode.indexOf(facingMode) === -1){
          result = false;
        }
      }
      return result;
    }

    //force user permission request
    //this fixes an issue on ios: if enumerateDevices is called before user grants permission
    //the number of returned devices is short (some devices are missing)
    try{
      let stream = await navigator.mediaDevices.getUserMedia({
        video: true
      });
      let track = stream.getVideoTracks()[0];
      track.stop();
    }catch(err){
      alert(err);
    }

    let cameras = [];
    let devices = await navigator.mediaDevices.enumerateDevices();
    log("Number of devices (video + audio) from enumerate ", devices.length);
    for (let i = 0; i < devices.length; i++) {
      let device = devices[i];
      if (device.kind === 'videoinput') {

        try {
          let stream = await navigator.mediaDevices.getUserMedia({
            video: {
              deviceId: device.deviceId
            }
          });
          let track = stream.getVideoTracks()[0];
          let cameraCapabilities = track.getCapabilities();

          //we need to ensure that no camera remains active
          track.stop();

          //log(device, cameraCapabilities);
          if(verifyConstraints(cameraCapabilities)){
            cameras.push({id:device.deviceId, label:device.label});
          }
        } catch (err) {
          alert(err);
        }
      }
    }
    return cameras;
  }

  async function test(){

    let environmentCameras = await getCameras("environment");
    log("environmentCameras ", `[${environmentCameras.length}] `, environmentCameras);

/*    let userCameras = await getCameras("user");
    log("userCameras ", `[${userCameras.length}] `, userCameras);

    let allCameras = await getCameras();
    log("all ", `[${allCameras.length}] `, allCameras);*/
  }

  test();

</script>
</html>
